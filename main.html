<!DOCTYPE html>
<html>
  <body>
    <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
    <!-- <div id="player"></div> --> <!-- YT API -->
    <div id="player"></div>

    <button onClick="getCurrTime()"> check Time </button>
    <div id="textTime">test</div>
    
    <form onSubmit="changeTime(event)">
      <label for="timeInput">Enter time (In Seconds)</label>
      <input type="number" id="timeInput" min = "0" required/>
      <button onClick="changeTime()"> changeTime to 8:20</button>
    </form>

    <!-- API Libraries -->
    <script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/videojs-youtube/dist/Youtube.min.js"></script>

    <!-- Video Player CSS-->
    <link href="https://unpkg.com/video.js@7/dist/video-js.min.css" rel="stylesheet">

    <script>
      //VIDEO JS Learning
      // Create <video> element
      const tag = document.createElement('video');
      tag.id = 'myVideo';
      tag.className = 'video-js vjs-default-skin';
      tag.setAttribute('controls', true);
      tag.setAttribute('width', 640);
      tag.setAttribute('height', 360);

      // Add to DOM
      document.getElementById('player').appendChild(tag);

      // Initialize Video.js
      const player = videojs('myVideo', {
        techOrder: ['youtube'],
        sources: [{
          type: 'video/youtube',
          src: 'https://www.youtube.com/watch?v=M7lc1UVf-VE'
        }],
        youtube: {
          modestbranding: 1,
          rel: 0
        }
      });

      // SOCKET.IO + video player event Listener at the very bottom
      // Add Socket.IO client script
      var socketScript = document.createElement('script');
      socketScript.src = "https://cdn.socket.io/4.7.4/socket.io.min.js";
      document.head.appendChild(socketScript);
      
      // Initialize Socket.IO connection after script loads
      socketScript.onload = function() {
        console.log("Socket.IO script loaded");
        
        // Create a div to show connection status
        const statusDiv = document.createElement('div');
        statusDiv.id = 'connection-status';
        statusDiv.textContent = 'Connecting to server...';
        document.body.appendChild(statusDiv);
        
        // Initialize Socket.IO connection
        const socket = io("http://localhost:8080", { //change this later to connect to our actual server
          reconnectionAttempts: 5,
          timeout: 10000,
          transports: ['websocket', 'polling']
        });
        
        // Connection established
        socket.on("connect", () => {
          console.log("Connected to Socket.IO server with ID:", socket.id);
          statusDiv.textContent = 'Connected to server';
          statusDiv.style.color = 'green';
          
          // Send a test message
          socket.emit("message", "Connection established");
        });
        
        // Receive server signal
        socket.on("signal", (data) => {
          console.log("Server signal:", data);
          // Display signal in UI
          const signalDiv = document.createElement('div');
          signalDiv.textContent = "Signal: " + data;
          document.body.appendChild(signalDiv);
        });
        
        // Listen for broadcast messages
        socket.on("broadcast", (data) => {
          console.log("Broadcast message:", data);
          // Display messages in UI
          const messageDiv = document.createElement('div');
          messageDiv.textContent = "Broadcast: " + data;
          document.body.appendChild(messageDiv);
        });
        
        // Handle connection errors
        socket.on("connect_error", (error) => {
          console.error("Connection error:", error);
          statusDiv.textContent = 'Connection error';
          statusDiv.style.color = 'red';
        });
        
        // Handle disconnection
        socket.on("disconnect", (reason) => {
          console.log("Disconnected from Socket.IO server:", reason);
          statusDiv.textContent = 'Disconnected from server';
          statusDiv.style.color = 'orange';
        });
        
        // Listen for any errors
        socket.on("error", (error) => {
          console.error("Socket error:", error);
          statusDiv.textContent = 'Socket error';
          statusDiv.style.color = 'red';
        });
        
        // Add button to send test messages, a way to create a function through here
        const sendButton = document.createElement('button');
        sendButton.textContent = "Send Test Message";
        sendButton.onclick = function() {
          const message = "Test message from client at " + new Date().toLocaleTimeString();
          socket.emit("message", message);
          
          // Visual feedback that message was sent
          const sentDiv = document.createElement('div');
          sentDiv.textContent = "Sent: " + message;
          sentDiv.style.color = 'blue';
          document.body.appendChild(sentDiv);
          
          console.log("Sent message:", message);
        };
        document.body.appendChild(sendButton);

        //VIDEO PLAYER HERE
        player.ready(() => {
          console.log('Player is ready');

          player.on('play', () => {
            const msg = "Video is Playing from " + player.currentTime();
            //console.log("Emitting playVideo event:", msg);
            socket.emit("play", msg);
          });

          player.on('pause', () => {
            //console.log('Paused')
            const msg = "Video is Paused from " + player.currentTime();
            socket.emit("pause", msg)
          });
          
          let lastTime = 0;
          player.on('timeupdate', ()=>{
            const current = player.currentTime();
            if(Math.abs(current - lastTime) > 2){
              const msg = `Jumped from ${lastTime.toFixed(2)} to ${current.toFixed(2)}`;
              socket.emit("timeUpdate", msg);
              console.log(msg);
            }
            lastTime = current;
          });
        });
      };


    </script>
  </body>
</html>